<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">

    <title>hexo-theme-doc-seed |  </title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    

    <!-- fonts -->
    <link href="//fonts.googleapis.com/css?family=Source+Sans+Pro:400,700" rel="stylesheet">
    <link href="//fonts.googleapis.com/css?family=Ubuntu:300,400,500,600,700" rel="stylesheet">

    <!-- stylesheets -->
    <link rel="stylesheet" href="/style/doc.css">

    <!-- favicon -->
    <link rel="icon" href="/images/favicon.ico">

    

  </head>
  <body>

   <script>window.__INITIAL_STATE__ = {"page":{"path":"book/gas.html","title":""},"data":{"navigation":{"logo":{"text":"Mastering Ethereum. Русский перевод","type":"link","path":"index.html"},"main":[{"text":"Оглавление","type":"label"},{"text":"Предисловие","type":"link","path":"book/preface.html"},{"text":"Глоссарий","type":"link","path":"book/glossary.html"},{"text":"Что такое Ethereum","type":"link","path":"book/what-is.html"},{"text":"Введение","type":"link","path":"book/intro.html"},{"text":"Клиенты Ethereum","type":"link","path":"book/clients.html"},{"text":"Тестнет Ethereum","type":"link","path":"book/ethereum-testnets.html"},{"text":"Ключи и Адреса","type":"link","path":"book/keys-addresses.html"},{"text":"Кошельки","type":"link","path":"book/wallets.html"},{"text":"Транзакции","type":"link","path":"book/transactions.html"},{"text":"Смарт контракты","type":"link","path":"book/smart-contracts.html"},{"text":"Инструменты разработчика и фреймворки","type":"link","path":"book/dev-tools.html"},{"text":"Токены","type":"link","path":"book/tokens.html"},{"text":"DApps","type":"link","path":"book/dapps.html"},{"text":"Ораклы","type":"link","path":"book/oracles.html"},{"text":"Accounting & Gas","type":"link","path":"book/gas.html"},{"text":"EVM","type":"link","path":"book/evm.html"},{"text":"Консенсус","type":"link","path":"book/consensus.html"},{"text":"Vyper","type":"link","path":"book/vyper.html"},{"text":"Протокол DevP2P","type":"link","path":"book/devp2p-protocol.html"},{"text":"Стандарты Ethereum (EIPs/ERCs)","type":"link","path":"book/standards-eip-erc.html"},{"text":"История форков (DAO/ETC)","type":"link","path":"book/forks-history.html"},{"text":"Дополнительно","type":"label"},{"text":"Комментировать на Github","type":"link","path":"https://github.com/ethereumbook-ru/ethereumbook-ru.github.io/issues/new"}]}},"config":{"timezone":"UTC","root":"/","time_format":"HH:mm:ss","theme":"../node_modules/hexo-theme-doc","theme_config":{"swagger_ui":{"version":2,"permalinks":true,"api_explorer":true,"download":"Download specification","show_extensions":false,"deep_linking":true,"display_operation_id":false,"doc_expansion":"none"},"search":{"skip":false,"background":false,"route":"/lunr.json"},"favicon":"images/favicon.ico"}}}</script>

    <div id="react-navigation-root"><div class="doc-navigation" data-reactroot=""><nav class="doc-navbar"><a href="/index.html" class="doc-navbar__logo"><img src="/images/logo.png" class="doc-navbar__logo__img"/><span class="doc-navbar__logo__text">Mastering Ethereum. Русский перевод</span></a><i class="dc-icon dc-icon--close dc-icon--interactive doc-sidebar-close doc-navbar__sidebar-close doc-navbar__sidebar-close--desktop"></i><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-navbar__sidebar-toggle"></i></nav><nav class="doc-sidebar"><div class="doc-sidebar__vertical-menu"><i class="dc-icon dc-icon--menu dc-icon--interactive doc-sidebar-toggle doc-sidebar-toggle--primary doc-sidebar__vertical-menu__item"></i><i class="dc-icon dc-icon--search dc-icon--interactive doc-sidebar__vertical-menu__item doc-sidebar__vertical-menu__item--primary"></i></div><div class="doc-sidebar-content"><div class="doc-sidebar__search-form"></div><ul class="doc-sidebar-list"></ul></div></nav></div></div>
    <div class="doc-content">
  <div class="dc-page">
    <div class="dc-card">
      <div id="react-search-results-root"></div>
      <div id="page-content" class="doc-formatting">
        <p>[[gas]]<br>== Gas</p>
<p>////<br>Add high-level introduction, from a transactional and network perspective. then move to transactional - what is gas (unit to measure computational resources?), who needs it - when and why, how do you know how much is needed, how do you get it, what if I have too much, what if I don’t have enough. move to block level, how does this transaction fit overall in a block (prioritization), who decides size, who decides fixed gas, gas refund. Future of gas.<br>////</p>
<p><strong>Gas</strong> is Ethereum’s unit for measuring how much computational work a program takes to perform an action or a set of actions. Every operation performed by a transaction or contract costs a certain number of gas; the number of gas required is related to the type and number of computational steps that are being executed. In contrast to Bitcoin transaction fees, which only take into account the size of a transaction in kilobytes (kB), Ethereum transaction fees must account for an arbitrary number of computational steps that can be performed by smart contract code. The higher the number of operations a program performs, the higher the cost to run it to completion.</p>
<p>Each operation requires a fixed amount of gas. Some examples from the Ethereum yellow paper:</p>
<ul>
<li>Adding two numbers costs 3 gas</li>
<li>Calculating a Keccak256 hash costs 30 gas + 6 more gas for every 256 bits of data being hashed</li>
<li>Sending a transaction costs 21000 gas</li>
</ul>
<p>Gas is a crucial component of Ethereum and serves a dual role. One, as a layer of abstraction between the price of ethereum(with its volatility) and the reward to miners for the work they do. And the other being a defense against denial of service attacks. In order to prevent accidental or malicious infinite loops or other computational wastage in the network, the initiator of each transaction is required to set a limit to the amount they are willing to spend on gas. The gas system, therefore, disincentivizes attackers from sending spam transactions, as they must pay proportionately for the computational, bandwidth, and storage resources that they consume.</p>
<p>=== Halting Problem</p>
<p>////<br>TODO<br>////</p>
<p>The idea of transaction fees and accounting seems practical, though you might wonder why Ethereum requires gas in the first place. Gas is pivotal, as it not only attends to the halting problem but is also critical for safety and liveness. What is the halting problem, safety, and liveness, and why should you care?</p>
<p>=== Paying for gas</p>
<p>While gas has a price, it cannot be “owned” nor “spent”. Gas exists only inside the Ethereum Virtual Machine (EVM) as a count of how much computational work is being performed. The sender is charged a transaction fee in ether, which is then converted to gas and then back to ether as block rewards for the miners. These conversion steps are in place to separate the price for the computation (tied to amount of “work”) from the price of ether (tied to market fluctuations).</p>
<p>=== Gas cost vs. gas price</p>
<p>While the <strong>gas cost</strong> is a measure of operational steps performed in the EVM, the gas itself also has a <strong>gas price</strong> measured in ether. When performing a transaction, the sender specifies the gas price they are willing to pay (in ether) for each unit of gas, allowing the market to decide the relationship between the price of ether and the cost of computing operations (as measured in gas).</p>
<p><code>total gas used * gas price paid = transaction fee</code> in ether</p>
<p>This amount is deducted from the sender’s account at the start of the transaction execution. Instead of “total gas used”, the sender is to set a <strong>gas limit</strong> that should be sufficient to cover the amount of gas required to perform the transaction.</p>
<p>=== Gas cost limit and running out of gas</p>
<p>Before sending a transaction, senders must specify a <strong>gas limit</strong> - the maximum amount of gas they are willing to buy. They must also specify the <strong>gas price</strong> - the price in ether they are willing to pay for each unit of gas.</p>
<p><code>gas limit * gas price</code> in ether is deducted from the sender’s account at the start of transaction execution as a deposit. This is to prevent the sender from going “bankrupt” mid-execution and being unable to pay for gas costs. Users are also unable to set a gas limit that exceeds their account balance for this reason.</p>
<p>Ideally, the sender will set a gas limit that is higher than or equal to the gas actually used. If the gas limit is set higher than the amount of gas consumed, the sender will receive a refund of the excess amount, as miners are only compensated for the work they actually perform.</p>
<p>In which case:</p>
<p><code>(gas limit - excess gas) * gas price</code> ether goes to the miner as a block reward</p>
<p><code>excess gas * gas price</code> ether is refunded to the sender</p>
<p>However, if the gas used exceeds the specified gas limit, i.e. if the transaction “runs of out gas” during execution, the operation is terminated. Although the transaction was unsuccessful, the sender will not get their transaction fee back as miners have already performed the computational work up to that point, and will be compensated for doing so.</p>
<p>==== Example </p>
<p>////<br>Let’s look at an example.<br>////</p>
<p>If the transaction is being sent from an Externally Owned Account (EOA), the gas fee is withdrawn from the EOA’s balance. In other words, the initiator of the transaction is paying for the gas. The initiator funds the total gas consumed by the transaction as well as any sub-executions that follow. This means that if the initiator X attaches 1000 gas to call contract A, which spends 500 gas on computation and then sends another message to contract B, the gas used by A to send the message to B is also deducted from X’s gas limit specified at the start.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">An EOA account X initiates a transaction and calls functions on contract account A, attaching 1000 gas</span><br><span class="line"></span><br><span class="line">Contract A spends 500 gas on computation and sends a message costing 100 gas to Contract B</span><br><span class="line"></span><br><span class="line">Contract B spends 300 gas on computation and completes the transaction.</span><br><span class="line"></span><br><span class="line">100 gas gets refunded to X</span><br></pre></td></tr></table></figure>
<p>An intermediary contract (e.g. contract A in our example) that executes a portion of the operations in a transaction can therefore theoretically run out of gas if the initiator of that transaction did not attach a high enough gas fee at the start. In cases where contracts run out of gas mid-execution, all state changes are reverted except the gas fee payments.</p>
<p>=== Estimating Gas </p>
<p>////<br>Source: <a href="https://ethereum.stackexchange.com/a/515/19763" target="_blank" rel="noopener">https://ethereum.stackexchange.com/a/515/19763</a><br>License: CC0<br>Added by: @naveensrinivasan<br>////</p>
<p>Estimating gas works by pretending the transaction was actually being included in the blockchain, and then returning the exact gas amount that would have been charged if that pretend operation was real. In other words, it uses the exact same procedure a miner would use to calculate the actual fee but never mined into the blockchain.</p>
<p>Note that the estimate may be significantly more than the amount of gas actually used by the transaction, for a variety of reasons including EVM mechanics and node performance.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> result = web3.eth.estimateGas(&#123;</span><br><span class="line">    to: <span class="string">"0xc4abd0339eb8d57087278718986382264244252f"</span>, </span><br><span class="line">    data: <span class="string">"0xc6888fa10000000000000000000000000000000000000000000000000000000000000003"</span></span><br><span class="line">&#125;);</span><br><span class="line"><span class="built_in">console</span>.log(result); <span class="comment">// "0x0000000000000000000000000000000000000000000000000000000000000015"</span></span><br></pre></td></tr></table></figure>
<p>=== Gas price and transaction prioritization</p>
<p>Gas price is the amount in ether that the transaction sender is willing to pay for each unit of gas used. The miner who mines the next block gets to decide which transactions to include. Since gas price is factored into the transaction fee they will receive as a reward, they are more likely to include transactions with highest gas prices first. If the sender sets the gas price too low, they may have to wait a long time before their transaction makes it into a block.</p>
<p>Miners can also decide the order in which transactions are included in a block. Since multiple miners are competing to append their block to the blockchain, the order of transactions within a block is arbitrarily decided by the “winning” miner and then the other miners verify with that order. While transactions from different accounts can be ordered arbitrarily, transactions from an individual account are executed in order of an auto-incrementing nonce.</p>
<p>=== Block gas limit</p>
<p>Block gas limits are the maximum amount of gas allowed in a block to determine how many transactions can fit into a block. For example, let’s say we have 5 transactions where each transaction has a gas limit of 10, 20, 30, 40, and 50. If the block gas limit is 100, then the first four transactions can fit in the block, while transaction 5 has to wait for a future block. As previously discussed, miners decide which transactions to include in a block. A different miner could try including the last 2 transactions in the block (50+40), and they only have space to include the first transaction (10). If you try to include a transaction that requires more gas than the current block gas limit, it will be rejected by the network and your Ethereum client will give you the message “Transaction exceeds block gas limit.” The block gas limit is currently around 5 million gas at the time of writing according to <a href="https://etherscan.io" target="_blank" rel="noopener">https://etherscan.io</a>, meaning around 238 transactions that each consume 21000 gas can fit in 1 block.</p>
<p>=== Who decides what the block gas limit is?</p>
<p>Miners on the network decide what the block gas limit is. Individuals who want to mine on the Ethereum network use a mining program, such as ethminer, which connects to a Geth or Parity Ethereum client. The Ethereum protocol has a built in mechanism where miners can vote on the gas limit so capacity can be increased without having to coordinate on a hard fork. The miner of a block is able to adjust the block gas limit by a factor of 1/1024 (0.0976%) in either direction. The result of this is an adjustable block size based on the needs of the network at the time. This mechanism is coupled with a default mining strategy where miners would vote on a gas limit which is at least 4.7 million, but which would target 150% of the recent (1024-block exponential moving) average gas used if that amount is higher, allowing capacity to organically increase. Miners can choose to change this, but many of them do not and leave the default.</p>
<p>=== Gas refund<br>Ethereum encourages deleting storage variables by refunding up to half the amount of the gas cost.<br>There are 2 operations in the EVM with negative gas:</p>
<p>Clearing a contract is -24,000 (SELFDESTRUCT)<br>Clearing storage is -15,000 (SSTORE[x] = 0)</p>
<p>==== GasToken</p>
<p>GasToken is an ERC20 compliant token that allows anyone to “bank” gas when the gas price is low and uses it when gas price is high. By making it a tradeable asset, it essentially creates a gas market.<br>It works by taking advantage of the gas refund mechanism described earlier.</p>
<p>You can learn about the maths involved in calculating the profitability and how to use the released gas at <a href="https://gastoken.io/" target="_blank" rel="noopener">https://gastoken.io/</a></p>
<p>=== Rent fee<br>There is currently a proposal in the Ethereum community about charging smart contracts a “rent fee” to be kept alive.</p>
<p>In the case the rent would not be paid, the smart contract would be put to “sleep” making it and it’s data inaccessible even for a simple read. A contract put into sleep would need to be awakened by paying rent and submitting a Merkle proof.</p>
<p><a href="https://github.com/ethereum/EIPs/issues/35" target="_blank" rel="noopener">https://github.com/ethereum/EIPs/issues/35</a><br><a href="https://ethresear.ch/t/a-simple-and-principled-way-to-compute-rent-fees/1455" target="_blank" rel="noopener">https://ethresear.ch/t/a-simple-and-principled-way-to-compute-rent-fees/1455</a><br><a href="https://ethresear.ch/t/improving-the-ux-of-rent-with-a-sleeping-waking-mechanism/1480" target="_blank" rel="noopener">https://ethresear.ch/t/improving-the-ux-of-rent-with-a-sleeping-waking-mechanism/1480</a></p>

        <div id="react-support-footer-root"></div>
      </div>
    </div>
  </div>
</div>

    


    

    <!-- js vendors -->
    <script src="//code.jquery.com/jquery-3.2.1.min.js" crossorigin="anonymous"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/lunr.js/2.1.0/lunr.min.js"></script>

    <!-- js source  -->
    <script src="/script/doc.js"></script>

    

  </body>
</html>
