<!DOCTYPE HTML>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>Цифровые подписи - Осваиваем Ethereum - Mastering Ethereum</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="Руководство по Ethereum и разработке смарт-контрактов">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <base href="../../">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme -->
        

        

        <!-- Fetch Clipboard.js from CDN but have a local fallback -->
        <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js"></script>
        <script>
            if (typeof Clipboard == 'undefined') {
                document.write(unescape("%3Cscript src='clipboard.min.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch JQuery from CDN but have a local fallback -->
        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script>
            if (typeof jQuery == 'undefined') {
                document.write(unescape("%3Cscript src='jquery.js'%3E%3C/script%3E"));
            }
        </script>

        <!-- Fetch store.js from local - TODO add CDN when 2.x.x is available on cdnjs -->
        <script src="store.js"></script>

    </head>
    <body class="light">
        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme = store.get('mdbook-theme');
            if (theme === null || theme === undefined) { theme = 'light'; }
            $('body').removeClass().addClass(theme);
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var sidebar = store.get('mdbook-sidebar');
            if (sidebar === "hidden") { $("html").addClass("sidebar-hidden") }
            else if (sidebar === "visible") { $("html").addClass("sidebar-visible") }
        </script>

        <div id="sidebar" class="sidebar">
            <ul class="chapter"><li class="affix"><a href="./1_предисловие.html">Предисловие</a></li><li class="affix"><a href="./2_глоссарий.html">Глоссарий</a></li><li><a href="./kniga/что_такое_ethereum.html"><strong>1.</strong> Что такое Ethereum?</a></li><li><a href="./kniga/введение.html"><strong>2.</strong> Введение</a></li><li><a href="./kniga/клиенты.html"><strong>3.</strong> Клиенты</a></li><li><a href="./kniga/ключи_и_адреса.html"><strong>4.</strong> Ключи и адреса</a></li><li><a href="./kniga/кошельки.html"><strong>5.</strong> Кошельки</a></li><li><a href="./kniga/транзакции.html"><strong>6.</strong> Транзакции</a></li><li><ul class="section"><li><a href="./kniga/tx/structure.html"><strong>6.1.</strong> Структура_транзакции</a></li><li><a href="./kniga/tx/nonce.html"><strong>6.2.</strong> Nonce транзакции</a></li><li><a href="./kniga/tx/gas.html"><strong>6.3.</strong> Топливо (Gas)</a></li><li><a href="./kniga/tx/recipient.html"><strong>6.4.</strong> Получатель</a></li><li><a href="./kniga/tx/value_data.html"><strong>6.5.</strong> Value и Data</a></li><li><a href="./kniga/tx/create_contract_tx.html"><strong>6.6.</strong> Тразакция создания контракта</a></li><li><a href="./kniga/tx/digital_signatures.html" class="active"><strong>6.7.</strong> Цифровые подписи</a></li><li><a href="./kniga/tx/sign_prifix_value.html"><strong>6.8.</strong> Восстановление открытого ключа</a></li><li><a href="./kniga/tx/sign_transmission.html"><strong>6.9.</strong> Раздельное подписание и передача</a></li><li><a href="./kniga/tx/tx_propagation.html"><strong>6.10.</strong> Распространение транзакций</a></li><li><a href="./kniga/tx/recording_on_blockchain.html"><strong>6.11.</strong> Запись в блокчейне</a></li><li><a href="./kniga/tx/multisig.html"><strong>6.12.</strong> Мультиподпись</a></li></ul></li><li><a href="./kniga/смарт_контракты_на_solidity.html"><strong>7.</strong> Смарт-контракты на Solidity</a></li><li><strong>8.</strong> Смарт-контракты на Vyper</li><li><a href="./kniga/безопаность_смарт_контрактов.html"><strong>9.</strong> Безопаность смарт-контрактов</a></li><li><a href="./kniga/токены.html"><strong>10.</strong> Токены</a></li><li><a href="./kniga/оракулы.html"><strong>11.</strong> Оракулы</a></li><li><a href="./kniga/децентрализованные_приложения.html"><strong>12.</strong> Децентрализованные приложения</a></li><li><a href="./kniga/виртуальная_машина_ethereum.html"><strong>13.</strong> Виртуальная машина Ethereum</a></li><li><a href="./kniga/консенсус.html"><strong>14.</strong> Консенсус</a></li><li><strong>15.</strong> Доп 1. История ветвлений</li><li><a href="./kniga/дополнение_2_стандарты_eip_erc.html"><strong>16.</strong> Доп 2. Стандарты EIP, ERC</a></li><li><a href="./kniga/дополнение_3_коды_evm_и_gas.html"><strong>17.</strong> Доп 3. Коды EVM и газ</a></li><li><a href="./kniga/дополнение_4_инструменты_solidity_разработчика.html"><strong>18.</strong> Доп 4. Инструменты разработчика</a></li><li><a href="./kniga/дополнение_5_руководство_по_web3js.html"><strong>19.</strong> Доп 5. Руководство по web3js</a></li><li class="spacer"></li><li class="affix"><a href="./support.html">Поддержка проекта</a></li></ul>
        </div>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page" tabindex="-1">
                
                <div id="menu-bar" class="menu-bar">
                    <div class="left-buttons">
                        <i id="sidebar-toggle" class="fa fa-bars" title="Toggle sidebar"></i>
                        <i id="theme-toggle" class="fa fa-paint-brush" title="Change theme"></i>
                    </div>

                    <h1 class="menu-title">Осваиваем Ethereum - Mastering Ethereum</h1>

                    <div class="right-buttons">
                        <a href="print.html">
                            <i id="print-button" class="fa fa-print" title="Print this book"></i>
                        </a>
                    </div>
                </div>

                <div id="content" class="content">
                    <a class="header" href="./kniga/tx/digital_signatures.html#Цифровые-подписи" id="Цифровые-подписи"><h2>Цифровые подписи</h2></a>
<p>До сих пор мы не вдавались в подробности о цифровых подписях. В этом разделе мы рассмотрим, как работают цифровые подписи и как их можно использовать для представления доказательства владения закрытым ключом без раскрытия этого закрытого ключа.</p>
<a class="header" href="./kniga/tx/digital_signatures.html#Алгоритм-эллиптической-кривой-цифровой-подписи" id="Алгоритм-эллиптической-кривой-цифровой-подписи"><h3>Алгоритм эллиптической кривой цифровой подписи</h3></a>
<p>Алгоритм цифровой подписи, используемый в Ethereum, - это алгоритм цифровой подписи на основе эллиптической кривой (ECDSA). Он основан на парах закрытых и открытых ключей с эллиптической кривой, как описано в [elliptic_curve].</p>
<p>Цифровая подпись служит трем целям в Ethereum.</p>
<ol>
<li>Во-первых, подпись доказывает, что владелец закрытого ключа, который по косвенным признакам является владельцем счета в Ethereum, санкционировал расходование ether или выполнение контракта.</li>
<li>Во-вторых, она гарантирует неотказуемость: доказательство авторизации является неоспоримым.</li>
<li>В-третьих, подпись доказывает, что данные транзакции не были и не могут быть изменены кем-либо после подписания транзакции.</li>
</ol>
<p><strong>Определение цифровой подписи в Википедии:</strong> Цифровая подпись - это математическая схема для подтверждения подлинности цифровых сообщений или документов. Действительная цифровая подпись дает получателю основания полагать, что сообщение было создано известным отправителем (аутентификация), что отправитель не может отрицать факт отправки сообщения (неотрицание) и что сообщение не было изменено при передаче (целостность).</p>
<a class="header" href="./kniga/tx/digital_signatures.html#Как-работают-цифровые-подписи" id="Как-работают-цифровые-подписи"><h3>Как работают цифровые подписи</h3></a>
<p>Цифровая подпись - это математическая схема, состоящая из двух частей.</p>
<ol>
<li>Алгоритм создания подписи с помощью закрытого ключа (ключа подписи) из сообщения (в нашем случае это транзакция).</li>
<li>Алгоритм, который позволяет любому человеку проверить подпись, используя только сообщение и открытый ключ.</li>
</ol>
<a class="header" href="./kniga/tx/digital_signatures.html#Создание-цифровой-подписи" id="Создание-цифровой-подписи"><h4>Создание цифровой подписи</h4></a>
<p>В реализации ECDSA в Ethereum <strong>транзакция</strong> это &quot;сообщение&quot;, которое подписывается. А точнее, хэш Keccak-256 данных транзакции, закодированных в RLP. Ключом подписи
закрытый ключ EOA. Результатом является подпись:</p>
<p>Sig = Fsig(Fkeccak256 (m), k)</p>
<p>где:</p>
<ul>
<li>k - закрытый ключ подписи</li>
<li>m - транзакция, закодированная в RLP</li>
<li>Fkeccak256 - хэш-функция Keccak-256</li>
<li>Fsig - алгоритм подписи</li>
<li>Sig - результирующая подпись</li>
</ul>
<p>Функция Fsig создает подпись Sig, состоящую из двух значений, обычно называемых <strong>r</strong> и <strong>s</strong>:
Sig = (r, s)</p>
<a class="header" href="./kniga/tx/digital_signatures.html#Проверка-подписи" id="Проверка-подписи"><h4>Проверка подписи</h4></a>
<p>Чтобы проверить подпись, необходимо иметь подпись (<strong>r</strong> и <strong>s</strong>), <strong>сериализованную транзакцию</strong> и <strong>открытый ключ</strong>, соответствующий закрытому ключу, использованному для создания подписи. По сути, проверка подписи означает, что &quot;только владелец закрытого ключа, создавшего этот открытый ключ, мог создать эту подпись на данной транзакции&quot;.</p>
<p>Алгоритм проверки подписи принимает <strong>сообщение</strong> (т.е. хэш транзакции для нашего использования), <strong>открытый ключ подписанта</strong> и <strong>подпись</strong> (значения r и s) и возвращает true, если подпись действительна для данного сообщения и открытого ключа.</p>
<a class="header" href="./kniga/tx/digital_signatures.html#Математика-ecdsa" id="Математика-ecdsa"><h4>Математика ECDSA</h4></a>
<p>Как упоминалось ранее, подписи создаются с помощью математической функции <strong>Fsig</strong>, которая производит подпись, состоящую из двух значений, <strong>r</strong> и <strong>s</strong>. В этом разделе мы рассмотрим функцию <strong>Fsig</strong> более подробно.</p>
<p>Алгоритм подписи сначала генерирует эфемерный (временный) закрытый ключ криптографически безопасным способом. Этот временный ключ используется при вычислении значений <strong>r</strong> и <strong>s</strong>, чтобы гарантировать, что реальный личный ключ отправителя не может быть вычислен злоумышленниками, наблюдающими за подписанными транзакциями в сети Ethereum.</p>
<p>Как мы знаем из [pubkey], эфемерный закрытый ключ используется для получения соответствующего (эфемерного) открытого ключа, поэтому мы имеем:</p>
<ul>
<li>криптографически безопасное случайное число <strong>q</strong>, которое используется в качестве эфемерного закрытого ключа</li>
<li>Соответствующий эфемерный открытый ключ <strong>Q</strong>, сгенерированный из <strong>q</strong> и точки генератора эллиптической кривой <strong>G</strong></li>
</ul>
<p>В этом случае значение r цифровой подписи является координатой <strong>x</strong> эфемерного открытого ключа <strong>Q</strong>.</p>
<p>Далее алгоритм вычисляет значение s подписи, такое, что:</p>
<p>s ≡ q^-1(Keccak256(m) + r * k) (mod p)</p>
<p>где:</p>
<ul>
<li>q - эфемерный закрытый ключ</li>
<li>r - координата x эфемерного открытого ключа</li>
<li>k - закрытый ключ подписывающего (владельца EOA)</li>
<li>m - данные транзакции</li>
<li>p - простой порядок эллиптической кривой.</li>
</ul>
<p>Проверка - это обратная функция генерации подписи, использующая значения <strong>r</strong> и <strong>s</strong> и <strong>открытый ключ отправителя</strong> для вычисления значения <strong>Q</strong>, которое является точкой на эллиптической кривой (эфемерный открытый ключ, использованный при создании подписи).</p>
<p>Этапы работы следующие:</p>
<ol>
<li>Проверьте правильность формирования всех входов</li>
<li>Вычислите w = s^-1 mod p</li>
<li>Рассчитайте u1 = Keccak256(m) * w mod p</li>
<li>Рассчитайте u2 = r * w mod p</li>
<li>Наконец, вычислите точку на эллиптической кривой Q ≡ u1 * G + u2 * K (mod p).</li>
</ol>
<p>где:</p>
<ul>
<li>r и s - значения подписи</li>
<li>K - открытый ключ подписанта (владельца EOA)</li>
<li>m - данные транзакции, которая была подписана</li>
<li>G - точка генератора эллиптической кривой</li>
<li>p - простой порядок эллиптической кривой.</li>
</ul>
<p>Если координата <strong>x</strong> вычисленной точки <strong>Q</strong> равна __r, то проверяющий может сделать вывод, что подпись действительна.</p>
<p>Обратите внимание, что при проверке подписи закрытый ключ не известен и не раскрыт.</p>
<p><strong>Совет:</strong> ECDSA - это довольно сложная математика; полное объяснение выходит за рамки этой книги. В Интернете можно найти множество замечательных руководств, в которых все объясняется шаг за шагом: наберите в поисковике &quot;ECDSA explained&quot; или попробуйте вот это: <a href="https://www.instructables.com/Understanding-how-ECDSA-protects-your-data">Understanding How ECDSA Protects Your Data</a> .</p>
<a class="header" href="./kniga/tx/digital_signatures.html#Подписание-транзакций-на-практике" id="Подписание-транзакций-на-практике"><h4>Подписание транзакций на практике</h4></a>
<p>Чтобы транзакция была действительной, отправитель должен подписать сообщение цифровой подписью, используя алгоритм цифровой подписи с эллиптической кривой. Когда мы говорим &quot;подписать транзакцию&quot;, мы на самом деле имеем в виду &quot;подписать хэш Keccak-256 данных RLP-сериализованной транзакции&quot;. Подпись применяется к хэшу данных транзакции, а не к самой транзакции.</p>
<p>Чтобы подписать транзакцию в Ethereum, инициатор должен:</p>
<ol>
<li>Создайте структуру данных транзакции, содержащую девять полей: nonce, gasPrice, gasLimit, to, value, data, chainID, 0, 0.</li>
<li>Создать RLP-кодированное сериализованное сообщение структуры данных транзакции.</li>
<li>Вычислите хэш Keccak-256 этого сериализованного сообщения.</li>
<li>Вычислите подпись ECDSA, подписав хэш закрытым ключом отправителя EOA.</li>
<li>Добавьте вычисленные значения v, r и s подписи ECDSA к транзакции.</li>
</ol>
<p>Специальная переменная подписи <strong>v</strong> указывает на две вещи: идентификатор цепочки и идентификатор восстановления, чтобы помочь функции <strong>ECDSArecover</strong> проверить подпись. Она вычисляется как одно из 27 или 28, либо как удвоенный идентификатор цепочки плюс 35 или 36. Дополнительную информацию об идентификаторе цепочки см. в разделе Создание необработанной транзакции с помощью EIP-155. Идентификатор восстановления (27 или 28 в подписях &quot;старого стиля&quot; или 35 или 36 в полных транзакциях в стиле Spurious Dragon) используется для указания четности y-компонента открытого ключа (подробнее см. раздел Значение префикса подписи (v) и восстановление открытого ключа).</p>
<p><strong>Примечание:</strong> В блоке № 2,675,000 Ethereum реализовал хард форк &quot;Spurious Dragon&quot;, который, среди прочих изменений, ввел новую схему подписания, включающую защиту от воспроизведения транзакций (предотвращение воспроизведения транзакций, предназначенных для одной сети, в других). Эта новая схема подписания указана в EIP-155. Это изменение влияет на форму транзакции и ее подпись, поэтому необходимо обратить внимание на первую из трех переменных подписи (т.е. v), которая принимает одну из двух форм и указывает на поля данных, включенные в хэшируемое сообщение транзакции.</p>
<a class="header" href="./kniga/tx/digital_signatures.html#Создание-и-подписание-необработанных-транзакций" id="Создание-и-подписание-необработанных-транзакций"><h4>Создание и подписание необработанных транзакций</h4></a>
<p>В этом разделе мы создадим необработанную транзакцию и подпишем ее, используя библиотеку <strong>ethereumjs-tx</strong>, которую можно установить с помощью <strong>npm</strong>. Это демонстрирует функции, которые обычно используются в кошельке или приложении, подписывающем транзакции от имени пользователя.</p>
<p>Исходный код этого примера находится в файле raw_tx_demo.js в репозитории GitHub книги:
<code>link:code/web3js/raw_tx/raw_tx_demo.js[]</code></p>
<p>Выполнение кода примера дает следующие результаты:</p>
<pre><code>$ node raw_tx_demo.js
RLP-Encoded Tx: 0xe6808609184e72a0008303000094b0920c523d582040f2bcb1bd7fb1c7c1...
Tx Hash: 0xaa7f03f9f4e52fcf69f836a6d2bbc7706580adce0a068ff6525ba337218e6992
Signed Raw Transaction: 0xf866808609184e72a0008303000094b0920c523d582040f2bcb1...
</code></pre>
<a class="header" href="./kniga/tx/digital_signatures.html#Создание-необработанных-транзакций-с-помощью-eip-155" id="Создание-необработанных-транзакций-с-помощью-eip-155"><h4>Создание необработанных транзакций с помощью EIP-155</h4></a>
<p>Стандарт EIP-155 &quot;Простая защита от атак повторного воспроизведения&quot; определяет кодирование транзакций с защитой от атак повторного воспроизведения, которое включает идентификатор цепочки внутри данных транзакции перед подписанием. Это гарантирует, что транзакции, созданные для одного блокчейна (например, основной сети Ethereum), будут недействительны на другом блокчейне (например, Ethereum Classic или тестовой сети Ropsten). Таким образом, транзакции, транслируемые в одной сети, не могут быть воспроизведены в другой, отсюда и название стандарта.</p>
<p>EIP-155 добавляет три поля к основным шести полям структуры данных транзакции, а именно: идентификатор цепочки, 0 и 0. Эти три поля добавляются к данным транзакции до их кодирования и хэширования. Таким образом, они изменяют хэш транзакции, к которому впоследствии применяется подпись. Включая идентификатор цепочки в подписываемые данные, подпись транзакции предотвращает любые изменения, поскольку при изменении идентификатора цепочки подпись становится недействительной. Таким образом, EIP-155 делает невозможным воспроизведение транзакции на другой цепи, поскольку действительность подписи зависит от идентификатора цепи.</p>
<p>Поле идентификатора цепи принимает значение в соответствии с сетью, для которой предназначена транзакция, как описано в разделе Идентификаторы цепи.</p>
<p>Таблица 1. Идентификаторы цепей</p>
<table><thead><tr><th> Цепь                         </th><th> Идентификатор цепи </th></tr></thead><tbody>
<tr><td> Ethereum mainnet             </td><td> 1                  </td></tr>
<tr><td> Morden (устаревшее), Expanse </td><td> 2                  </td></tr>
<tr><td> Ropsten                      </td><td> 3                  </td></tr>
<tr><td> Rinkeby                      </td><td> 4                  </td></tr>
<tr><td> Основная сеть Rootstock      </td><td> 30                 </td></tr>
<tr><td> Испытательная сеть Rootstock </td><td> 31                 </td></tr>
<tr><td> Kovan                        </td><td> 42                 </td></tr>
<tr><td> Ethereum Classic mainnet     </td><td> 61                 </td></tr>
<tr><td> Ethereum Classic testnet     </td><td> 62                 </td></tr>
<tr><td> Geth частные сети            </td><td> 1337               </td></tr>
</tbody></table>
<p>Полученная структура транзакции кодируется RLP, хэшируется и подписывается. Алгоритм подписи немного модифицирован, чтобы кодировать идентификатор цепочки в префиксе v.</p>
<p>Более подробную информацию см. в спецификации EIP-155.</p>

                </div>

                <!-- Mobile navigation buttons -->
                
                    <a rel="prev" href="./kniga/tx/create_contract_tx.html" class="mobile-nav-chapters previous" title="Previous chapter">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a rel="next" href="./kniga/tx/sign_prifix_value.html" class="mobile-nav-chapters next" title="Next chapter">
                        <i class="fa fa-angle-right"></i>
                    </a>
                

            </div>

            
                <a href="./kniga/tx/create_contract_tx.html" class="nav-chapters previous" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-left"></i>
                </a>
            

            
                <a href="./kniga/tx/sign_prifix_value.html" class="nav-chapters next" title="You can navigate through the chapters using the arrow keys">
                    <i class="fa fa-angle-right"></i>
                </a>
            

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if ($(".fa").css("font-family") !== "FontAwesome") {
                $('<link rel="stylesheet" type="text/css" href="_FontAwesome/css/font-awesome.css">').prependTo('head');
            }
        </script>

        <!-- Livereload script (if served using the cli tool) -->
        

        

        

        

        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS script -->
        

    </body>
</html>
